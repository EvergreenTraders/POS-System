name: Deploy to AWS

on:
  # Manual deployment trigger only - click "Run workflow" button in GitHub Actions
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Run database migrations'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: ca-central-1
  EB_APPLICATION_NAME: pos-system
  EB_ENVIRONMENT_NAME: pos-system-prod
  FRONTEND_S3_BUCKET: pos-system-frontend
  NODE_VERSION: '20'
  MIGRATION_KEY: pos-system-migration-secret-2024

jobs:
  deploy-backend:
    name: Deploy Backend to Elastic Beanstalk
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci --production

      - name: Generate deployment package
        run: |
          cd backend
          zip -r ../deploy.zip . -x "node_modules/*" "*.git*" "*.env*"
          cd ..
          zip -r deploy.zip .platform/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload package to S3
        run: |
          aws s3 cp deploy.zip s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/pos-system/deploy-${{ github.sha }}.zip

      - name: Create new Elastic Beanstalk version
        run: |
          # Check if version already exists
          if aws elasticbeanstalk describe-application-versions \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --version-labels deploy-${{ github.sha }} \
            --query 'ApplicationVersions[0]' \
            --output text 2>/dev/null | grep -q deploy-${{ github.sha }}; then
            echo "Version deploy-${{ github.sha }} already exists, skipping creation"
          else
            aws elasticbeanstalk create-application-version \
              --application-name ${{ env.EB_APPLICATION_NAME }} \
              --version-label deploy-${{ github.sha }} \
              --source-bundle S3Bucket="elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}",S3Key="pos-system/deploy-${{ github.sha }}.zip"
          fi

      - name: Deploy to Elastic Beanstalk
        run: |
          aws elasticbeanstalk update-environment \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
            --version-label deploy-${{ github.sha }}

      - name: Wait for deployment
        run: |
          echo "Waiting for environment to update..."
          aws elasticbeanstalk wait environment-updated \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }}
          echo "âœ“ Backend deployment complete!"

  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: ${{ github.event.inputs.run_migrations == 'true' }}

    steps:
      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to be fully deployed and healthy..."
          EB_URL="http://${{ env.EB_ENVIRONMENT_NAME }}.eba-3fkkan5u.${{ env.AWS_REGION }}.elasticbeanstalk.com"

          for i in {1..30}; do
            if curl -sf "$EB_URL/api/health" > /dev/null 2>&1; then
              echo "âœ“ Backend is ready!"
              break
            fi
            echo "Waiting for backend... attempt $i/30"
            sleep 10
          done

          # Final check
          if ! curl -sf "$EB_URL/api/health" > /dev/null 2>&1; then
            echo "âœ— Backend failed to become ready after 5 minutes"
            exit 1
          fi

      - name: Run migrations via API
        run: |
          echo "Running database migrations via API..."

          EB_URL="http://${{ env.EB_ENVIRONMENT_NAME }}.eba-3fkkan5u.${{ env.AWS_REGION }}.elasticbeanstalk.com"

          echo "Calling migration endpoint at $EB_URL/api/migrate"

          # Call the migration endpoint with increased timeout
          RESPONSE=$(curl -X POST "$EB_URL/api/migrate" \
            -H "X-Migration-Key: ${{ env.MIGRATION_KEY }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP_STATUS:%{http_code}" \
            --max-time 300 \
            -s)

          # Extract HTTP status
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')

          echo "Response:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"

          # Check if successful
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ“ Database migrations completed successfully!"
          else
            echo "âœ— Migration failed with HTTP status: $HTTP_STATUS"
            echo "Response body: $BODY"
            exit 1
          fi

  deploy-frontend:
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build React app
        run: |
          cd frontend
          npm run build
        env:
          CI: false
          REACT_APP_API_URL: http://${{ env.EB_ENVIRONMENT_NAME }}.eba-3fkkan5u.${{ env.AWS_REGION }}.elasticbeanstalk.com/api

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/build/ s3://${{ env.FRONTEND_S3_BUCKET }}/ --delete
          echo "âœ“ Frontend deployed to S3!"

      - name: Output deployment URL
        run: |
          echo "ðŸš€ Deployment complete!"
          echo "Frontend URL: http://${{ env.FRONTEND_S3_BUCKET }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          echo "Backend URL: http://${{ env.EB_ENVIRONMENT_NAME }}.eba-3fkkan5u.${{ env.AWS_REGION }}.elasticbeanstalk.com"
